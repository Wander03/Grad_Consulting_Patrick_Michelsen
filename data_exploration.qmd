---
title: "EDA"
author: "Andrew Kerr"
format: html
editor: source
toc: true
code-fold: true
embed-resources: true
---

## Set-up

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(janitor)
library(readxl)
library(writexl)
library(patchwork)
library(glmmTMB)
library(car)
```

## Data Read-in

### Convert 3 .csv to 1 Excel File (DO NOT NEED TO RUN)

```{r}
#| message: false
#| eval: false
df_combined <- read_csv(here::here("data", "Combined_Master.csv")) %>% clean_names()
df_year_1 <- read_csv(here::here("data", "Year1_Master.csv")) %>% clean_names()
df_year_2 <- read_csv(here::here("data", "Year2_Master.csv")) %>% clean_names()

# Change date format
df_combined <- df_combined %>%
  select(-bad_date) %>% # Remove unnecessary column
  mutate(date = as.Date(date, format="%m_%d_%Y"))

df_year_1 <- df_year_1 %>%
  mutate(date = as.Date(date, format="%m_%d_%Y"))

df_year_2 <- df_year_2 %>%
  mutate(date = as.Date(date, format="%m_%d_%Y"))

# Save as single Excel File
out <- list("combined" = df_combined, "year_1" = df_year_1, "year_2" = df_year_2)
write_xlsx(out, "data/Master.xlsx")
```

### Read-in Data from Excel File

```{r}
df_combined <- read_xlsx(here::here("data", "Master.xlsx"), sheet = "combined")
df_year_1 <- read_xlsx(here::here("data", "Master.xlsx"), sheet = "year_1")
df_year_2 <- read_xlsx(here::here("data", "Master.xlsx"), sheet = "year_2")
```

```{r}
df_combined <- df_combined %>%
  mutate(
    sample_id = as.factor(sample_id),
    site = as.factor(site),
    block = as.factor(block),
    study_year = as.factor(study_year)
  )

df_year_1 <- df_year_1 %>%
  mutate(
    sample_id = as.factor(sample_id),
    site = as.factor(site),
    block = as.factor(block),
    study_year = as.factor(study_year)
  )

df_year_2 <- df_year_2 %>%
  mutate(
    sample_id = as.factor(sample_id),
    site = as.factor(site),
    block = as.factor(block),
    study_year = as.factor(study_year)
  )
```

## EDA

### Create Datasets where LOD is 0 or NA

```{r}
#| warning: false
response_vars <- c("nh4", "nitrate", "mg", "p", "ec", "p_h")

df_combined_LOD_0 <- df_combined %>%
    mutate(across(
    all_of(response_vars), 
    ~ {
      # Replace "LOD" with 0
      x <- ifelse(.x == "LOD", 0, .x)
      as.numeric(x)
    }
  ))

df_combined_LOD_NA <- df_combined %>%
    mutate(across(
    all_of(response_vars), 
    ~ {
      # Replace "LOD" with NA
      x <- ifelse(.x == "LOD", NA, .x)
      as.numeric(x)
    }
  ))
```

### Count of Zeros

```{r}
prop_zero_0 <- df_combined_LOD_0 %>%
  summarise(across(
    all_of(response_vars), 
    ~ {
      x <- mean(.x == 0, na.rm = T)
      }
    )) %>%
  pivot_longer(cols = everything(), names_to = "response", values_to = "prop_zero")

prop_zero_NA <- df_combined_LOD_NA %>%
  summarise(across(
    all_of(response_vars), 
    ~ {
      x <- mean(.x == 0, na.rm = T)
      }
    )) %>%
  pivot_longer(cols = everything(), names_to = "response", values_to = "prop_zero")

prop_zero_0 %>%
  left_join(prop_zero_NA, by = "response", suffix = c("_0", "_NA")) %>%
  arrange(-prop_zero_0)
```

### Negative Values

```{r}
prop_neg_0 <- df_combined_LOD_0 %>%
  summarise(across(
    all_of(response_vars), 
    ~ {
      x <- mean(.x < 0, na.rm = T)
      }
    )) %>%
  pivot_longer(cols = everything(), names_to = "response", values_to = "prop_negative")

prop_neg_NA <- df_combined_LOD_NA %>%
  summarise(across(
    all_of(response_vars), 
    ~ {
      x <- mean(.x < 0, na.rm = T)
      }
    )) %>%
  pivot_longer(cols = everything(), names_to = "response", values_to = "prop_negative")

prop_neg_0 %>%
  left_join(prop_neg_NA, by = "response", suffix = c("_0", "_NA")) %>%
  arrange(-prop_negative_0)
```

### Concentration by Treatment Box Plots

```{r}
#| fig.width: 14
#| fig.height: 10
capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}

plot_concentration <- function(r, data) {
  data %>% 
    filter(.data[[r]] > 0) %>%
    ggplot(aes(x = treatment, y = .data[[r]], fill = treatment)) +
      geom_boxplot(alpha = 0.7) +
      geom_point(alpha = 0.3) +
      facet_wrap(vars(study_year), scales = "free") +
      labs(title = paste0(capwords(r), " Concentration (Non-Zero) by Treatment"), x = "Treatment", y = capwords(r)) +
      theme_bw()
}

plots_0 <- map(response_vars, plot_concentration, data = df_combined_LOD_0)
wrap_plots(plots_0, ncol = 2, guides = "collect")

# It will be the same since we are plotting non-zeros
# plots_NA <- map(response_vars, plot_concentration, data = df_combined_LOD_NA)
# wrap_plots(plots_NA, ncol = 2, guides = "collect")
```


### Plot Response Variables Over Time

```{r}
#| warning: false
#| fig.width: 14
#| fig.height: 10
capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}

plot_response <- function(r, data, by) {
  data %>%
    ggplot(aes(x = date, y = .data[[r]], color = .data[[by]])) +
    facet_wrap(vars(study_year), scales = "free") +
    geom_point() +
    geom_line() +
    theme_bw(base_size = 12) +
    theme(legend.position = "none") +
    labs(
      title = paste0(capwords(r), " Over Time"),
      x = "Date"
    )
}
  
plots_0 <- map(response_vars, plot_response, data = df_combined_LOD_0, by = "sample_id")
wrap_plots(plots_0, ncol = 2)

plots_NA <- map(response_vars, plot_response, data = df_combined_LOD_NA, by = "sample_id")
wrap_plots(plots_NA, ncol = 2)
```

## Zero-Inflated Model

### With Random Effects

```{r}
# Errors due to non-positive values (does not work with Gamma)
# glmmTMB(
#     p ~ treatment + site * study_year + sample_id + (1 | site/block) + (1 | sample_id),
#     zi = ~ treatment + site + study_year,
#     family = Gamma(link = "log"),
#     data = df_combined_LOD_0
# )

fit <- glmmTMB(
    p ~ treatment + site + study_year + as.numeric(factor(date)) + (1 | site/block) + (1 | sample_id),
    zi = ~ treatment + site + study_year,
    family = lognormal(link = "log"),
    data = df_combined_LOD_0
)

summary(fit)
```

The above model appears not to converge (or something) since all the values are NaN, therefore we will try a model without random effects.

### Without Random Effects

```{r}
fit_no_re <- glmmTMB(
    p ~ treatment + site + study_year + as.numeric(factor(date)),
    zi = ~ treatment + site + study_year,
    family = lognormal(link = "log"),
    data = df_combined_LOD_0
)

summary(fit_no_re)
```

Since no random effects worked, we will try adding the random effects back separately.

### With Some Random Effects

```{r}
fit_site_block <- glmmTMB(
    p ~ treatment + site + study_year + as.numeric(factor(date)) + (1 | site/block),
    zi = ~ treatment + site + study_year,
    family = lognormal(link = "log"),
    data = df_combined_LOD_0
)

summary(fit_site_block)
```

```{r}
fit_sample_id <- glmmTMB(
    p ~ treatment + site + study_year + as.numeric(factor(date)) + (1 | sample_id),
    zi = ~ treatment + site + study_year,
    family = lognormal(link = "log"),
    data = df_combined_LOD_0
)

summary(fit_sample_id)
```

### Model Comparison 

```{r}
AIC(fit_no_re, fit_sample_id)
```

### Model Diagnostics

```{r}
simulationOutput <- simulateResiduals(fittedModel = fit_no_re, plot = TRUE)
```

```{r}
testZeroInflation(simulationOutput)
```

```{r}
testDispersion(simulationOutput)
```

### 

```{r}
fit_quadratic <- glmmTMB(
    p ~ treatment + site * study_year + poly(as.numeric(factor(date)), 2) + (1 | sample_id),
    zi = ~ treatment + site + study_year,
    family = lognormal(link = "log"),
    data = df_combined_LOD_0
)

summary(fit_quadratic)

simulationOutput <- simulateResiduals(fittedModel = fit_quadratic, plot = TRUE)
testZeroInflation(fit_quadratic)
testDispersion(fit_quadratic)
```

